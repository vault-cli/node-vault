<!DOCTYPE html>

<html>
<head>
  <title>index.js</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="commands.html">
                  commands.js
                </a>
              
                
                <a class="source" href="index.html">
                  index.js
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>index.js</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-1">&#x00a7;</a>
              </div>
              
            </div>
            
            <div class="content"><div class='highlight'><pre><span class="hljs-meta">&#x27;use strict&#x27;</span>;

<span class="hljs-keyword">import</span> originalTv4 <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;tv4&quot;</span>;
<span class="hljs-keyword">import</span> <span class="hljs-title class_">Commands</span> <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;./commands.js&quot;</span>;
<span class="hljs-keyword">import</span> originalMustache <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;mustache&quot;</span>;
<span class="hljs-keyword">import</span> http <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;http&quot;</span>;
<span class="hljs-keyword">import</span> https <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;https&quot;</span>;
<span class="hljs-keyword">import</span> axios <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;axios&quot;</span>;
<span class="hljs-keyword">import</span> debug0 <span class="hljs-keyword">from</span> <span class="hljs-string">&quot;debug&quot;</span>;

<span class="hljs-keyword">const</span> originalDebug = <span class="hljs-title function_">debug0</span>(<span class="hljs-string">&#x27;vaultaire&#x27;</span>);

<span class="hljs-keyword">class</span> <span class="hljs-title class_">VaultError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">Error</span> {}

<span class="hljs-keyword">class</span> <span class="hljs-title class_">ApiResponseError</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_ inherited__">VaultError</span> {
  <span class="hljs-title function_">constructor</span>(<span class="hljs-params">message, response</span>) {
    <span class="hljs-variable language_">super</span>(message);
    <span class="hljs-variable language_">this</span>.<span class="hljs-property">response</span> = {
      <span class="hljs-attr">statusCode</span>: response.<span class="hljs-property">statusCode</span>,
      <span class="hljs-attr">body</span>: response.<span class="hljs-property">body</span>,
    };
  }
}

<span class="hljs-keyword">function</span> <span class="hljs-title function_">NodeVault</span>(<span class="hljs-params">config = {}</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-2">&#x00a7;</a>
              </div>
              <p>load conditional dependencies</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">const</span> debug = config.<span class="hljs-property">debug</span> || originalDebug;
  <span class="hljs-keyword">const</span> tv4 = config.<span class="hljs-property">tv4</span> || originalTv4;
  <span class="hljs-keyword">const</span> commands = config.<span class="hljs-property">commands</span> || <span class="hljs-title class_">Commands</span>;
  <span class="hljs-keyword">const</span> mustache = config.<span class="hljs-property">mustache</span> || originalMustache;

  <span class="hljs-keyword">let</span> requestPromise = (config[<span class="hljs-string">&#x27;request-promise&#x27;</span>] || axios);</pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-3">&#x00a7;</a>
              </div>
              <p>This code sets axios.create.request as the default
Request function
that NodeVault will use</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">if</span> (requestPromise != <span class="hljs-literal">null</span> &amp;&amp; requestPromise.<span class="hljs-property">create</span> != <span class="hljs-literal">null</span>) {
    requestPromise = requestPromise.<span class="hljs-title function_">create</span>({
    });
    <span class="hljs-keyword">if</span> (requestPromise != <span class="hljs-literal">null</span> &amp;&amp; requestPromise.<span class="hljs-property">options</span> != <span class="hljs-literal">null</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-4">&#x00a7;</a>
              </div>
              <p>Set Default Options fo this requestPromise
Handles strictSSL config of Old API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">const</span> strictSSL = !process.<span class="hljs-property">env</span>.<span class="hljs-property">VAULT_SKIP_VERIFY</span>;
      requestPromise.<span class="hljs-property">defaults</span>.<span class="hljs-property">httpsAgent</span> = <span class="hljs-keyword">new</span> https.<span class="hljs-title class_">Agent</span>({ <span class="hljs-attr">rejectUnauthorized</span>: strictSSL });
      requestPromise.<span class="hljs-property">defaults</span>.<span class="hljs-property">httpAgent</span> = <span class="hljs-keyword">new</span> http.<span class="hljs-title class_">Agent</span>();</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-5">&#x00a7;</a>
              </div>
              <p>Handles Params
simple &amp;&amp; resolveWithFullResponse
Like Old API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      requestPromise.<span class="hljs-property">defaults</span>.<span class="hljs-property">validateStatus</span> = <span class="hljs-function">(<span class="hljs-params">_</span>) =&gt;</span> <span class="hljs-literal">true</span> &amp;&amp; _;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-6">&#x00a7;</a>
              </div>
              <p>Handles json = true
Like Old API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      requestPromise.<span class="hljs-property">defaults</span>.<span class="hljs-property">responseType</span> = <span class="hljs-string">&#x27;json&#x27;</span>;
    }
    <span class="hljs-keyword">if</span> (requestPromise != <span class="hljs-literal">null</span> &amp;&amp; requestPromise.<span class="hljs-property">request</span> != <span class="hljs-literal">null</span>) {
      requestPromise = requestPromise.<span class="hljs-property">request</span>;
    }
  }
  <span class="hljs-keyword">const</span> client = {};

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">handleVaultResponse</span>(<span class="hljs-params">response</span>) {
    <span class="hljs-keyword">if</span> (!response) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">VaultError</span>(<span class="hljs-string">&#x27;No response passed&#x27;</span>));
    response.<span class="hljs-property">statusCode</span> = response.<span class="hljs-property">statusCode</span> || response.<span class="hljs-property">status</span>;
    response.<span class="hljs-property">body</span> = response.<span class="hljs-property">body</span> || response.<span class="hljs-property">data</span>;
    <span class="hljs-title function_">debug</span>(response.<span class="hljs-property">statusCode</span>);
    <span class="hljs-keyword">if</span> (response.<span class="hljs-property">statusCode</span> !== <span class="hljs-number">200</span> &amp;&amp; response.<span class="hljs-property">statusCode</span> !== <span class="hljs-number">204</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-7">&#x00a7;</a>
              </div>
              <p>handle health response not as error</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (response.<span class="hljs-property">request</span>.<span class="hljs-property">path</span>.<span class="hljs-title function_">match</span>(<span class="hljs-regexp">/sys\/health/</span>) !== <span class="hljs-literal">null</span>) {
        <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(response.<span class="hljs-property">body</span>);
      }
      <span class="hljs-keyword">let</span> message;
      <span class="hljs-keyword">if</span> (response.<span class="hljs-property">body</span> &amp;&amp; response.<span class="hljs-property">body</span>.<span class="hljs-property">errors</span> &amp;&amp; response.<span class="hljs-property">body</span>.<span class="hljs-property">errors</span>.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        message = response.<span class="hljs-property">body</span>.<span class="hljs-property">errors</span>[<span class="hljs-number">0</span>];
      } <span class="hljs-keyword">else</span> {
        message = <span class="hljs-string">`Status <span class="hljs-subst">${response.statusCode}</span>`</span>;
      }
      <span class="hljs-keyword">const</span> error = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ApiResponseError</span>(message, response);
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(error);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(response.<span class="hljs-property">body</span>);
  }

  client.<span class="hljs-property">handleVaultResponse</span> = handleVaultResponse;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-8">&#x00a7;</a>
              </div>
              <p>defaults</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  client.<span class="hljs-property">apiVersion</span> = config.<span class="hljs-property">apiVersion</span> || <span class="hljs-string">&#x27;v1&#x27;</span>;
  client.<span class="hljs-property">endpoint</span> = config.<span class="hljs-property">endpoint</span> || process.<span class="hljs-property">env</span>.<span class="hljs-property">VAULT_ADDR</span> || <span class="hljs-string">&#x27;http://127.0.0.1:8200&#x27;</span>;
  client.<span class="hljs-property">pathPrefix</span> = config.<span class="hljs-property">pathPrefix</span> || process.<span class="hljs-property">env</span>.<span class="hljs-property">VAULT_PREFIX</span> || <span class="hljs-string">&#x27;&#x27;</span>;
  client.<span class="hljs-property">token</span> = config.<span class="hljs-property">token</span> || process.<span class="hljs-property">env</span>.<span class="hljs-property">VAULT_TOKEN</span>;
  client.<span class="hljs-property">noCustomHTTPVerbs</span> = config.<span class="hljs-property">noCustomHTTPVerbs</span> || <span class="hljs-literal">false</span>;
  client.<span class="hljs-property">namespace</span> = config.<span class="hljs-property">namespace</span> || process.<span class="hljs-property">env</span>.<span class="hljs-property">VAULT_NAMESPACE</span>;

  client.<span class="hljs-property">endpoint</span> = client.<span class="hljs-property">endpoint</span>.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/\/$/</span>, <span class="hljs-string">&#x27;&#x27;</span>);

  <span class="hljs-keyword">const</span> requestSchema = {
    <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;object&#x27;</span>,
    <span class="hljs-attr">properties</span>: {
      <span class="hljs-attr">path</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;string&#x27;</span>,
      },
      <span class="hljs-attr">method</span>: {
        <span class="hljs-attr">type</span>: <span class="hljs-string">&#x27;string&#x27;</span>,
      },
    },
    <span class="hljs-attr">required</span>: [<span class="hljs-string">&#x27;path&#x27;</span>, <span class="hljs-string">&#x27;method&#x27;</span>],
  };</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-9">&#x00a7;</a>
              </div>
              <p>Handle any HTTP requests</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  client.<span class="hljs-property">request</span> = <span class="hljs-function">(<span class="hljs-params">options = {}</span>) =&gt;</span> {
    <span class="hljs-keyword">const</span> valid = tv4.<span class="hljs-title function_">validate</span>(options, requestSchema);
    <span class="hljs-keyword">if</span> (!valid) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(tv4.<span class="hljs-property">error</span>);
    <span class="hljs-keyword">let</span> uri = <span class="hljs-string">`<span class="hljs-subst">${client.endpoint}</span>/<span class="hljs-subst">${client.apiVersion}</span><span class="hljs-subst">${client.pathPrefix}</span><span class="hljs-subst">${options.path}</span>`</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-10">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-10">&#x00a7;</a>
              </div>
              <p>Replace unicode encodings.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    uri = uri.<span class="hljs-title function_">replace</span>(<span class="hljs-regexp">/&amp;#x2F;/g</span>, <span class="hljs-string">&#x27;/&#x27;</span>);
    options.<span class="hljs-property">headers</span> = options.<span class="hljs-property">headers</span> || {};
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> client.<span class="hljs-property">token</span> === <span class="hljs-string">&#x27;string&#x27;</span> &amp;&amp; client.<span class="hljs-property">token</span>.<span class="hljs-property">length</span>) {
      options.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;X-Vault-Token&#x27;</span>] = options.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;X-Vault-Token&#x27;</span>] || client.<span class="hljs-property">token</span>;
    }
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">typeof</span> client.<span class="hljs-property">namespace</span> === <span class="hljs-string">&#x27;string&#x27;</span> &amp;&amp; client.<span class="hljs-property">namespace</span>.<span class="hljs-property">length</span>) {
      options.<span class="hljs-property">headers</span>[<span class="hljs-string">&#x27;X-Vault-Namespace&#x27;</span>] = client.<span class="hljs-property">namespace</span>;
    }
    options.<span class="hljs-property">url</span> = uri;
    <span class="hljs-title function_">debug</span>(options.<span class="hljs-property">method</span>, options.<span class="hljs-property">url</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-11">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-11">&#x00a7;</a>
              </div>
              <p>Old API relied on options.uri
Axios uses options.url
Added to ensure compatibility with Old API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    options.<span class="hljs-property">uri</span> = options.<span class="hljs-property">url</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-12">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-12">&#x00a7;</a>
              </div>
              <p>Axios uses options.data
Merge Data Received from Old API into new one</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    options.<span class="hljs-property">data</span> = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, options.<span class="hljs-property">data</span>, options.<span class="hljs-property">json</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-13">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-13">&#x00a7;</a>
              </div>
              <p>Old API relied on options.json
Added to ensure compatibility with Old API</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    options.<span class="hljs-property">json</span> = options.<span class="hljs-property">data</span>;

    <span class="hljs-keyword">if</span> (options.<span class="hljs-property">data</span> &amp;&amp; <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(options.<span class="hljs-property">data</span>).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) <span class="hljs-title function_">debug</span>(options.<span class="hljs-property">data</span>);
    <span class="hljs-keyword">return</span> <span class="hljs-title function_">requestPromise</span>(options).<span class="hljs-title function_">then</span>(client.<span class="hljs-property">handleVaultResponse</span>);
  };

  client.<span class="hljs-property">help</span> = <span class="hljs-function">(<span class="hljs-params">path, requestOptions</span>) =&gt;</span> {
    <span class="hljs-title function_">debug</span>(<span class="hljs-string">`help for <span class="hljs-subst">${path}</span>`</span>);
    <span class="hljs-keyword">const</span> options = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, config.<span class="hljs-property">requestOptions</span>, requestOptions);
    options.<span class="hljs-property">path</span> = <span class="hljs-string">`/<span class="hljs-subst">${path}</span>?help=1`</span>;
    options.<span class="hljs-property">method</span> = <span class="hljs-string">&#x27;GET&#x27;</span>;
    <span class="hljs-keyword">return</span> client.<span class="hljs-title function_">request</span>(options);
  };

  client.<span class="hljs-property">write</span> = <span class="hljs-function">(<span class="hljs-params">path, data, requestOptions</span>) =&gt;</span> {
    <span class="hljs-title function_">debug</span>(<span class="hljs-string">&#x27;write %o to %s&#x27;</span>, data, path);
    <span class="hljs-keyword">const</span> options = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, config.<span class="hljs-property">requestOptions</span>, requestOptions);
    options.<span class="hljs-property">path</span> = <span class="hljs-string">`/<span class="hljs-subst">${path}</span>`</span>;
    options.<span class="hljs-property">json</span> = data;
    options.<span class="hljs-property">method</span> = <span class="hljs-string">&#x27;PUT&#x27;</span>;
    <span class="hljs-keyword">return</span> client.<span class="hljs-title function_">request</span>(options);
  };

  client.<span class="hljs-property">read</span> = <span class="hljs-function">(<span class="hljs-params">path, requestOptions</span>) =&gt;</span> {
    <span class="hljs-title function_">debug</span>(<span class="hljs-string">`read <span class="hljs-subst">${path}</span>`</span>);
    <span class="hljs-keyword">const</span> options = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, config.<span class="hljs-property">requestOptions</span>, requestOptions);
    options.<span class="hljs-property">path</span> = <span class="hljs-string">`/<span class="hljs-subst">${path}</span>`</span>;
    options.<span class="hljs-property">method</span> = <span class="hljs-string">&#x27;GET&#x27;</span>;
    <span class="hljs-keyword">return</span> client.<span class="hljs-title function_">request</span>(options);
  };

  client.<span class="hljs-property">list</span> = <span class="hljs-function">(<span class="hljs-params">path, requestOptions</span>) =&gt;</span> {
    <span class="hljs-title function_">debug</span>(<span class="hljs-string">`list <span class="hljs-subst">${path}</span>`</span>);
    <span class="hljs-keyword">const</span> options = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, config.<span class="hljs-property">requestOptions</span>, requestOptions);
    options.<span class="hljs-property">path</span> = <span class="hljs-string">`/<span class="hljs-subst">${path}</span>`</span>;

    <span class="hljs-keyword">if</span> (client.<span class="hljs-property">noCustomHTTPVerbs</span>) {
      options.<span class="hljs-property">path</span> = <span class="hljs-string">`/<span class="hljs-subst">${path}</span>?list=1`</span>;
      options.<span class="hljs-property">method</span> = <span class="hljs-string">&#x27;GET&#x27;</span>;
    } <span class="hljs-keyword">else</span> {
      options.<span class="hljs-property">path</span> = <span class="hljs-string">`/<span class="hljs-subst">${path}</span>`</span>;
      options.<span class="hljs-property">method</span> = <span class="hljs-string">&#x27;LIST&#x27;</span>;
    }
    <span class="hljs-keyword">return</span> client.<span class="hljs-title function_">request</span>(options);
  };

  client.<span class="hljs-property">delete</span> = <span class="hljs-function">(<span class="hljs-params">path, requestOptions</span>) =&gt;</span> {
    <span class="hljs-title function_">debug</span>(<span class="hljs-string">`delete <span class="hljs-subst">${path}</span>`</span>);
    <span class="hljs-keyword">const</span> options = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, config.<span class="hljs-property">requestOptions</span>, requestOptions);
    options.<span class="hljs-property">path</span> = <span class="hljs-string">`/<span class="hljs-subst">${path}</span>`</span>;
    options.<span class="hljs-property">method</span> = <span class="hljs-string">&#x27;DELETE&#x27;</span>;
    <span class="hljs-keyword">return</span> client.<span class="hljs-title function_">request</span>(options);
  };

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">validate</span>(<span class="hljs-params">json, schema</span>) {</pre></div></div>
            
        </li>
        
        
        <li id="section-14">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-14">&#x00a7;</a>
              </div>
              <p>ignore validation if no schema</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    <span class="hljs-keyword">if</span> (schema === <span class="hljs-literal">undefined</span>) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
    <span class="hljs-keyword">const</span> valid = tv4.<span class="hljs-title function_">validate</span>(json, schema);
    <span class="hljs-keyword">if</span> (!valid) {
      <span class="hljs-title function_">debug</span>(tv4.<span class="hljs-property">error</span>.<span class="hljs-property">dataPath</span>);
      <span class="hljs-title function_">debug</span>(tv4.<span class="hljs-property">error</span>.<span class="hljs-property">message</span>);
      <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">reject</span>(tv4.<span class="hljs-property">error</span>);
    }
    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>();
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">extendOptions</span>(<span class="hljs-params">conf, options, args = {}</span>) {
    <span class="hljs-keyword">const</span> hasArgs = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(args).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>;
    <span class="hljs-keyword">if</span> (!hasArgs) <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(options);

    <span class="hljs-keyword">const</span> querySchema = conf.<span class="hljs-property">schema</span>.<span class="hljs-property">query</span>;
    <span class="hljs-keyword">if</span> (querySchema) {
      <span class="hljs-keyword">const</span> params = [];
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(querySchema.<span class="hljs-property">properties</span>)) {
        <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> args) {
          params.<span class="hljs-title function_">push</span>(<span class="hljs-string">`<span class="hljs-subst">${key}</span>=<span class="hljs-subst">${<span class="hljs-built_in">encodeURIComponent</span>(args[key])}</span>`</span>);
        }
      }
      <span class="hljs-keyword">if</span> (params.<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        options.<span class="hljs-property">path</span> += <span class="hljs-string">`?<span class="hljs-subst">${params.join(<span class="hljs-string">&#x27;&amp;&#x27;</span>)}</span>`</span>;
      }
    }

    <span class="hljs-keyword">const</span> reqSchema = conf.<span class="hljs-property">schema</span>.<span class="hljs-property">req</span>;
    <span class="hljs-keyword">if</span> (reqSchema) {
      <span class="hljs-keyword">const</span> json = {};
      <span class="hljs-keyword">for</span> (<span class="hljs-keyword">const</span> key <span class="hljs-keyword">of</span> <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(reqSchema.<span class="hljs-property">properties</span>)) {
        <span class="hljs-keyword">if</span> (key <span class="hljs-keyword">in</span> args) {
          json[key] = args[key];
        }
      }
      <span class="hljs-keyword">if</span> (<span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(json).<span class="hljs-property">length</span> &gt; <span class="hljs-number">0</span>) {
        options.<span class="hljs-property">json</span> = json;
      }
    }

    <span class="hljs-keyword">return</span> <span class="hljs-title class_">Promise</span>.<span class="hljs-title function_">resolve</span>(options);
  }

  <span class="hljs-keyword">function</span> <span class="hljs-title function_">generateFunction</span>(<span class="hljs-params">name, conf</span>) {
    client[name] = <span class="hljs-function">(<span class="hljs-params">args = {}</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> options = <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">assign</span>({}, config.<span class="hljs-property">requestOptions</span>, args.<span class="hljs-property">requestOptions</span>);
      options.<span class="hljs-property">method</span> = conf.<span class="hljs-property">method</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-15">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-15">&#x00a7;</a>
              </div>
              <p>replace args in path.</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      options.<span class="hljs-property">path</span> = mustache.<span class="hljs-title function_">render</span>(conf.<span class="hljs-property">path</span>, args);</pre></div></div>
            
        </li>
        
        
        <li id="section-16">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-16">&#x00a7;</a>
              </div>
              <p>no schema object -&gt; no validation</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">if</span> (!conf.<span class="hljs-property">schema</span>) {
        <span class="hljs-keyword">if</span> (options.<span class="hljs-property">method</span> === <span class="hljs-string">&#x27;POST&#x27;</span> || options.<span class="hljs-property">method</span> === <span class="hljs-string">&#x27;PUT&#x27;</span>) {
          options.<span class="hljs-property">json</span> = args;
        }
        <span class="hljs-keyword">return</span> client.<span class="hljs-title function_">request</span>(options);
      }</pre></div></div>
            
        </li>
        
        
        <li id="section-17">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-17">&#x00a7;</a>
              </div>
              <p>else do validation of request URL and body</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      <span class="hljs-keyword">let</span> promise = <span class="hljs-title function_">validate</span>(args, conf.<span class="hljs-property">schema</span>.<span class="hljs-property">req</span>)
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">validate</span>(args, conf.<span class="hljs-property">schema</span>.<span class="hljs-property">query</span>))
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">() =&gt;</span> <span class="hljs-title function_">extendOptions</span>(conf, options, args))
      .<span class="hljs-title function_">then</span>(<span class="hljs-function">(<span class="hljs-params">extendedOptions</span>) =&gt;</span> client.<span class="hljs-title function_">request</span>(extendedOptions));

      <span class="hljs-keyword">if</span> (conf.<span class="hljs-property">tokenSource</span>) {
        promise = promise.<span class="hljs-title function_">then</span>(<span class="hljs-function"><span class="hljs-params">response</span> =&gt;</span> {
          <span class="hljs-keyword">const</span> candidateToken = response.<span class="hljs-property">auth</span> &amp;&amp; response.<span class="hljs-property">auth</span>.<span class="hljs-property">client_token</span>;
          <span class="hljs-keyword">if</span> (candidateToken) {
            client.<span class="hljs-property">token</span> = candidateToken;
          }
          <span class="hljs-keyword">return</span> response;
        });
      }

      <span class="hljs-keyword">return</span> promise;
    };
  }

  client.<span class="hljs-property">generateFunction</span> = generateFunction;</pre></div></div>
            
        </li>
        
        
        <li id="section-18">
            <div class="annotation">
              
              <div class="sswrap ">
                <a class="ss" href="#section-18">&#x00a7;</a>
              </div>
              <p>protecting global object properties from being added
enforcing the immutable rule: <a href="https://github.com/airbnb/javascript#iterators-and-generators">https://github.com/airbnb/javascript#iterators-and-generators</a>
going the functional way first defining a wrapper function</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>  <span class="hljs-keyword">const</span> <span class="hljs-title function_">assignFunctions</span> = commandName =&gt; <span class="hljs-title function_">generateFunction</span>(commandName, commands[commandName]);
  <span class="hljs-title class_">Object</span>.<span class="hljs-title function_">keys</span>(commands).<span class="hljs-title function_">forEach</span>(assignFunctions);

  <span class="hljs-keyword">return</span> client;
}
<span class="hljs-keyword">export</span> <span class="hljs-keyword">default</span> <span class="hljs-title class_">NodeVault</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
